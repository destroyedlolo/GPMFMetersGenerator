/* AltitudeGraphic
 * Generate altitude graphics
 *

The altitudes diverge between the phone and the GoPro GPS:
- first because the signal quality can be bad
- second, the GoPro may start recording video before all satellites are acquired
This can create a jump / break when switching from GPX to GoPro samples.

 */
#include "AltitudeGfx.h"

#include <cstdio>
#include <cstdlib>
#include <cerrno>
#include <cstring>
#include <cmath>

static struct {
  int  	 width;
  int  	 height;
  int  	 bytes_per_pixel; /* 2:RGB16, 3:RGB, 4:RGBA */ 
  unsigned char 	 pixel_data[40 * 40 * 4 + 1];
} imgMountain = {
  40, 40, 4,
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\016\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\021\000\000\000\311\000\000\000\004\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\214\000\000\000\377\000\000\000^\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\040\000\000\000\370\000\000\000\377\000\000\000\334\000\000\000\004\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\246\000\000"
  "\000\377\000\000\000\377\000\000\000\377\000\000\000a\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\061\000\000\000\375\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\340"
  "\000\000\000\006\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\277\000\000\000"
  "\377\000\000\000\374\000\000\000\237\000\000\000\377\000\000\000\377\000\000\000e\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000M\000\000\000\377\000\000\000\377\000\000\000\233\377\377\377\377\000"
  "\000\000\350\000\000\000\377\000\000\000\341\000\000\000\007\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\003\000\000"
  "\000\324\000\000\000\377\000\000\000\366\000\000\000\034\377\377\377\377\000\000\000r\000\000\000\377\000\000"
  "\000\377\000\000\000i\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000f\000\000\000\377\000\000\000\377\000\000\000\201"
  "\377\377\377\377\377\377\377\377\377\377\377\377\000\000\000\344\000\000\000\377\000\000"
  "\000\345\000\000\000\011\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\014\000\000\000\346\000\000\000\377\000\000\000\351\377\377\377"
  "\377\377\377\377\377\377\377\377\377\377\377\377\377\000\000\000o\000\000\000\377\000\000"
  "\000\377\000\000\000l\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\200\000\000\000\377\000\000\000\377\000\000\000g\377\377\377\377"
  "\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\000\000\000\343"
  "\000\000\000\377\000\000\000\346\000\000\000\011\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\030\000\000\000\363\000\000\000\377\000\000\000\327\377\377\377\377"
  "\377\377\377\377\000\000\000.\000\000\000\233\377\377\377\377\377\377\377\377\000\000\000k"
  "\000\000\000\377\000\000\000\377\000\000\000p\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\230\000\000\000\377\000\000\000\377\000\000\000l\377\377\377\377\000"
  "\000\000H\000\000\000\362\000\000\000\377\000\000\000\314\000\000\000\032\000\000\000\007\000\000\000\352\000\000\000\377"
  "\000\000\000\347\000\000\000\012\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  ")\000\000\000\373\000\000\000\377\000\000\000\377\000\000\000\362\000\000\000\220\000\000\000\373\000\000\000\377\000"
  "\000\000\377\000\000\000\377\000\000\000\342\000\000\000\234\000\000\000\377\000\000\000\377\000\000\000\377\000\000"
  "\000t\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\063\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\262\000\000\000\377\000"
  "\000\000\376\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\372\000\000\000\302\000\000"
  "\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\351\000\000\000"
  "\014\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\"\000\000\000\367\000\000\000\200\000\000\000\000\000\000\000?\000\000\000\377\000\000\000\377\000\000\000\250"
  "\000\000\000_\000\000\000\371\000\000\000\377\000\000\000\357\000\000\000D\377\314f\377\000\000\000\205\000\000\000"
  "\377\000\000\000\377\000\000\000\337\000\000\000\212\000\000\000\377\000\000\000\377\000\000\000w\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\263\000"
  "\000\000\377\000\000\000\377\000\000\000\200\000\000\000\312\000\000\000\377\000\000\000\371\000\000\000\"\377\314"
  "\231\377\000\000\000A\000\000\000\315\000\000\000*\377\314f\377\377\314f\377\377\256L\377\000"
  "\000\000b\000\000\000\303\000\000\000\027\377\314f\377\000\000\000\335\000\000\000\377\000\000\000\354\000\000\000"
  "\015\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000L\000\000\000\377"
  "\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\217\377\314f\377"
  "\377\314\231\377\377\314\063\377\377\314f\377\377\314f\377\377\314f\377\377"
  "\314f\377\377\256L\377\377\300T\377\377\300T\377\377\256L\377\377\314f\377"
  "\000\000\000`\000\000\000\377\000\000\000\377\000\000\000{\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\004\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\010\000\000\000\335\000\000\000\377\000\000\000\365\000\000\000\355\000\000\000\377\000\000"
  "\000\377\000\000\000\357\377\314f\377\377\314f\377\377\314\231\377\377\314\063\377"
  "\377\314f\377\377\314f\377\377\314f\377\377\314f\377\377\256L\377\377\300"
  "T\377\377\300T\377\377\256L\377\377\314f\377\377\256L\377\000\000\000\332\000\000\000"
  "\377\000\000\000\355\000\000\000\017\000\000\000\000\000\000\000\036\000\000\000\305\000\000\000\006\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\177\000\000\000\377\000\000\000\377\000\000\000{\000\000\000\060\000\000\000\354\000\000\000\377\000\000\000v\377\314"
  "f\377\377\314f\377\377\314\231\377\377\314\063\377\377\314f\377\377\314f\377"
  "\377\314f\377\377\314f\377\377\256L\377\377\300T\377\377\300T\377\377\256"
  "L\377\377\314f\377\377\256L\377\000\000\000]\000\000\000\377\000\000\000\377\000\000\000\177\000\000"
  "\000\036\000\000\000\335\000\000\000\377\000\000\000[\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\"\000\000\000\366\000\000\000\377\000\000\000\332\377"
  "\300T\377\377\231\063\377\000\000\000\060\000\000\000\316\377\256L\377\377\314f\377\377"
  "\314f\377\377\314\231\377\377\314\063\377\377\314f\377\377\314f\377\377\314"
  "f\377\377\314f\377\377\256L\377\377\300T\377\377\300T\377\377\256L\377\377"
  "\314f\377\377\256L\377\377\314f\377\000\000\000\327\000\000\000\377\000\000\000\357\000\000\000\335"
  "\000\000\000\377\000\000\000\377\000\000\000\311\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\262\000\000\000\377\000\000\000\377\000\000\000H\377\300"
  "T\377\377\231\063\377\377\314f\377\377\314f\377\377\256L\377\377\314f\377"
  "\377\314f\377\377\314\231\377\377\314\063\377\377\314f\377\377\314f\377\377"
  "\314f\377\377\314f\377\377\256L\377\377\300T\377\377\300T\377\377\256L\377"
  "\377\314f\377\377\256L\377\377\314f\377\000\000\000Y\000\000\000\377\000\000\000\377\000\000\000"
  "\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\067\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000L\000\000\000\377\000\000\000\377\000\000\000\256\377\300T"
  "\377\377\300T\377\377\231\063\377\377\314f\377\377\314f\377\377\256L\377\377"
  "\314f\377\377\314f\377\377\314\231\377\377\314\063\377\377\314f\377\377\314"
  "f\377\377\314f\377\377\256L\377\377\300T\377\377\300T\377\377\300T\377\377"
  "\256L\377\377\314f\377\377\256L\377\377\314f\377\377\314f\377\000\000\000\324\000"
  "\000\000\377\000\000\000\377\000\000\000\263\000\000\000\375\000\000\000\377\000\000\000\244\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\010\000\000\000\335\000\000\000\377\000\000\000\365"
  "\000\000\000\037\377\300T\377\377\300T\377\377\231\063\377\377\314f\377\377\314f"
  "\377\377\256L\377\377\314f\377\377\314f\377\377\314\231\377\377\314\063\377"
  "\377\314f\377\377\314f\377\377\314f\377\377\256L\377\377\300T\377\377\300"
  "T\377\377\300T\377\377\256L\377\377\314f\377\377\256L\377\377\314f\377\377"
  "\314f\377\000\000\000U\000\000\000\377\000\000\000\241\377\314f\377\000\000\000\264\000\000\000\377\000\000"
  "\000\371\000\000\000\030\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\177\000\000\000\377"
  "\000\000\000\377\000\000\000{\377\300T\377\377\300T\377\377\300T\377\377\231\063\377\377"
  "\314f\377\377\314f\377\377\256L\377\377\314f\377\377\314f\377\377\314\231"
  "\377\377\314\063\377\377\314f\377\377\314f\377\377\314f\377\377\256L\377\377"
  "\300T\377\377\300T\377\377\256L\377\377\314f\377\377\314f\377\377\256L\377"
  "\377\314f\377\377\314f\377\377\256L\377\000\000\000z\377\314f\377\377\314f\377"
  "\000\000\000G\000\000\000\377\000\000\000\377\000\000\000\200\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\036\000\000\000\365\000\000\000\377\000\000\000\333\377\256L\377\377\300T\377\377\300T\377"
  "\377\300T\377\377\231\063\377\377\314f\377\377\314f\377\377\256L\377\377\314"
  "f\377\377\314f\377\377\314\231\377\377\314\063\377\377\314f\377\377\314f\377"
  "\377\314f\377\377\256L\377\377\300T\377\377\300T\377\377\256L\377\377\314"
  "f\377\377\314f\377\377\256L\377\377\314f\377\377\314f\377\377\256L\377\377"
  "\314f\377\377\314f\377\377\314\063\377\377\314f\377\000\000\000\327\000\000\000\377\000"
  "\000\000\351\000\000\000\007\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\262\000\000\000\377\000\000\000\377\000"
  "\000\000J\377\256L\377\377\300T\377\377\300T\377\377\300T\377\377\231\063\377"
  "\377\314f\377\377\314f\377\377\256L\377\377\314f\377\377\314f\377\377\314"
  "\231\377\377\314\063\377\377\314f\377\377\314f\377\377\314f\377\377\256L\377"
  "\377\300T\377\377\300T\377\377\256L\377\377\314f\377\377\314f\377\377\256"
  "L\377\377\314f\377\377\314f\377\377\256L\377\377\314f\377\377\314f\377\377"
  "\314\063\377\377\314\063\377\000\000\000l\000\000\000\377\000\000\000\377\000\000\000[\000\000\000\000\000\000"
  "\000\000\000\000\000L\000\000\000\377\000\000\000\377\000\000\000\312\000\000\000\063\000\000\000\063\000\000\000\063\000\000"
  "\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000"
  "\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000"
  "\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000\000\063\000\000"
  "\000\063\000\000\000\063\000\000\000\063\000\000\000@\000\000\000\371\000\000\000\377\000\000\000\310\000\000\000\000\000\000"
  "\000\010\000\000\000\334\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377"
  "\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000"
  "\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000"
  "\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000"
  "\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377"
  "\000\000\000\377\000\000\000\377\000\000\000\067\000\000\000\200\000\000\000\377\000\000\000\377\000\000\000\377\000\000"
  "\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000"
  "\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377"
  "\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000"
  "\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000"
  "\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\244\000\000\000"
  "M\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000"
  "\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000"
  "\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000"
  "U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000U\000\000\000O\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"
  "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000",
};

AltitudeGfx::AltitudeGfx(GPVideo &v, GPX *h, bool aforcegpx) : Gfx( 600,300, v, h ), soffx(0), forcegpx(aforcegpx) {
	this->calcScales();
}

void AltitudeGfx::calcScales( void ){

		/* Label */
	cairo_text_extents_t extents;
	cairo_t *cr = cairo_create(this->background);

	cairo_select_font_face(cr, "sans", CAIRO_FONT_SLANT_NORMAL, CAIRO_FONT_WEIGHT_BOLD);
	cairo_set_font_size(cr, 35);
	cairo_text_extents(cr, "8888", &extents);
	this->offy = extents.height + 5;
	this->posLabel = this->SX - extents.x_advance - 55;

	cairo_select_font_face(cr, "sans", CAIRO_FONT_SLANT_NORMAL, CAIRO_FONT_WEIGHT_NORMAL);
	cairo_set_font_size(cr, 27);
	cairo_text_extents(cr, "8888", &extents);
	this->offx = extents.x_advance + 10;

		/* Scales */
	if(this->hiking && this->hiking->isStory()){
		this->min_h = (((int)this->hiking->getMin().getAltitude())/50)*50;
		this->max_h = (((int)this->hiking->getMax().getAltitude())/50 + 1)*50;
		this->scale_w = (double)(this->SX - offx)/(double)this->hiking->getSampleCount();
	} else {
		this->min_h = (((int)this->video.getMin().getAltitude())/50)*50;
		this->max_h = (((int)this->video.getMax().getAltitude())/50 + 1)*50;
		this->scale_w = (double)(this->SX - offx)/(double)this->video.getSampleCount();
	}


	this->range_h = this->max_h - this->min_h;
	this->scale_h = (double)(this->SY - offy)/(double)this->range_h;
	this->delta_h = ((this->range_h/5)/50)*50;
	if(!this->delta_h)
		this->delta_h = this->range_h/5;

	if(this->hiking && this->hiking->isStory()){	// No offset here as we're not drawing a shadow
		this->soffx = this->offx + this->hiking->getCurrentStoryVideo().start * this->scale_w;
		this->sscale_w = (double)(this->hiking->getCurrentStoryVideo().end - this->hiking->getCurrentStoryVideo().start)/(double)this->video.getSampleCount() * this->scale_w;
	}

	cairo_destroy(cr);
}

void AltitudeGfx::drawGPX(cairo_t *cr, int offset){
	if(offset){	// drawing shadow
		cairo_set_line_width(cr, 4);
		cairo_set_source_rgba(cr, 0,0,0, 0.55);
	} else {	// drawing path
		cairo_set_source_rgb(cr, 1,1,1);
		cairo_set_line_width(cr, 2);
	}

	bool first = true;
	GPX::pkind prec = GPX::pkind::AFTERTRACE;

	for(int idx=0; idx < (int)this->hiking->getSampleCount(); idx++){
		auto &p = this->hiking->getSamples()[idx];
		GPX::pkind kind = this->hiking->positionKind(idx);

		int x = this->offx + idx*this->scale_w + offset;
		int y = this->SY - (p.getAltitude() - this->min_h)*this->scale_h + offset;

		if(kind != prec){
			prec = kind;
			if(offset){	// shadow
				if(kind == GPX::pkind::CURRENTVIDEO){	// entering in the current video
					this->drawGPMF(cr, offset, (uint32_t)-2);
					for(; idx < (int)this->hiking->getSampleCount(); idx++)	// skiping
						if(this->hiking->positionKind(idx) != GPX::pkind::CURRENTVIDEO){
							idx--;
							break;
						} 
					continue;
				}
			} else {
				if(!first){
					cairo_stroke(cr);	// Draw previous trace
					first = true;		// start a new one
				}
				switch(kind){
				case GPX::pkind::AFTERTRACE :
					cairo_set_source_rgb(cr, .85,.85,.85);
					break;
				case GPX::pkind::BEFOREVIDEO :
					cairo_set_source_rgb(cr, 0.11, 0.65, 0.88);
					break;
				case GPX::pkind::AFTERVIDEO :
					cairo_set_source_rgb(cr, 0.3, 0.4, 0.7);
					break;
				case GPX::pkind::BEFORETRACE :
					cairo_set_source_rgb(cr, 1,1,1);
					break;
				case GPX::pkind::CURRENTVIDEO :
					if(this->forcegpx){
						cairo_set_source_rgb(cr, 0.11, 0.65, 0.88);
					} else {
						if(!first)	// draw previous gfx
							cairo_line_to(cr, x, y);
						for(; idx < (int)this->hiking->getSampleCount(); idx++)	// skiping
							if(this->hiking->positionKind(idx) != GPX::pkind::CURRENTVIDEO){
								idx--;
								break;
							}
						first = true;
						continue;
					}
				}
			}
		}
		if(first){
			first = false;
			cairo_move_to(cr, x, y);
		} else
			cairo_line_to(cr, x, y);
	}

	if(offset)
		cairo_stroke_preserve(cr);
	else
		cairo_stroke(cr);
}

void AltitudeGfx::drawGPMF(cairo_t *cr, int offset, uint32_t current){
	if(current == (uint32_t)-1){	/* Drawing shadow */
		cairo_set_source_rgba(cr, 0,0,0, 0.55);
		cairo_set_line_width(cr, 5);
	} else if(current != (uint32_t)-2){	/* Drawing curve */
		cairo_set_line_width(cr, 3);
		cairo_set_source_rgb(cr, 0.11, 0.65, 0.88);	
	}

	if(this->hiking && this->hiking->isStory()){
		for(uint32_t i = 0; i < this->video.getSampleCount(); i++){
			int x = this->soffx + i*this->sscale_w + offset;
			int y = this->SY - (this->video[i].getAltitude() - this->min_h)*this->scale_h + offset;

			if(!i && current != uint32_t(-2))	/* First plot */
				cairo_move_to(cr, x, y);
			else
				cairo_line_to(cr, x, y);

			if(current == i){
				cairo_stroke(cr);
				cairo_move_to(cr, x, y);
				cairo_set_source_rgb(cr, 0.3, 0.5, 0.8);
			}
		}

		if(current != (uint32_t)-2)
			cairo_stroke(cr);
	} else {
		for(uint32_t i = 0; i < this->video.getSampleCount(); i++){
			int x = this->offx + i*this->scale_w + offset;
			int y = this->SY - (this->video[i].getAltitude() - this->min_h)*this->scale_h + offset;

			if(!i)	/* First plot */
				cairo_move_to(cr, x, y);
			else
				cairo_line_to(cr, x, y);

			if(current == i){
				cairo_stroke(cr);
				cairo_move_to(cr, x, y);
				cairo_set_source_rgb(cr, 1,1,1);
			}
		}

		if(current != uint32_t(-1))
			cairo_stroke(cr);
		else
			cairo_stroke_preserve(cr);
	}
}

void AltitudeGfx::generateBackground( void ){
	cairo_surface_t *icn = cairo_image_surface_create_for_data (
		imgMountain.pixel_data,
	    CAIRO_FORMAT_ARGB32,
		imgMountain.width, imgMountain.height,
		40*4
	);
	if(cairo_surface_status(icn) != CAIRO_STATUS_SUCCESS){
		fprintf(stderr, "Creating icon : %s\n", cairo_status_to_string(cairo_surface_status(icn)));
		cairo_surface_destroy(icn);
		icn = NULL;
	}

	cairo_t *cr = cairo_create(this->background);

	cairo_select_font_face(cr, "sans", CAIRO_FONT_SLANT_NORMAL, CAIRO_FONT_WEIGHT_NORMAL);
	cairo_set_font_size(cr, 27);
	cairo_set_source_rgba(cr, 1,1,1, 0.80);	/* Set white color */
	cairo_set_line_width(cr, 1);

	char t[8];
	for(int i = this->min_h; i <= this->max_h; i += this->delta_h){
		int y = this->SY - (i-this->min_h)*this->scale_h;
		sprintf(t, "%5d", i);

		cairo_move_to(cr, 3, y);
		cairo_show_text(cr, t);
		cairo_move_to(cr, this->offx, y);
		cairo_line_to(cr, this->SX, y);
	}
	cairo_stroke(cr);


	if(icn){
		cairo_save(cr);
		cairo_set_source_surface(cr, icn, this->posLabel-imgMountain.width, 2);
		cairo_rectangle(cr, this->posLabel-imgMountain.width, 2, imgMountain.width, imgMountain.height);
		cairo_fill(cr);
		cairo_restore(cr);
	}

		// Draw Shadow
	if(this->hiking && this->hiking->isStory())
		this->drawGPX(cr, 3);
	else
		this->drawGPMF(cr, 3);

	cairo_pattern_t *pat = cairo_pattern_create_linear(this->offx,this->SY - this->range_h*this->scale_h, this->offx,this->SY);
	cairo_pattern_add_color_stop_rgba(pat, 0, 0,0,0, 0.25);
	cairo_pattern_add_color_stop_rgba(pat, 1, 0,0,0, 0.05);
	cairo_set_source(cr, pat);

	cairo_line_to(cr, this->SX, this->SY);
	cairo_line_to(cr, this->offx, this->SY);
	cairo_line_to(cr, this->offx, this->SY - (this->video.getFirst().getAltitude() - this->min_h)*this->scale_h);

	cairo_fill(cr);

	if(this->hiking && this->hiking->isStory())
		drawGPX(cr, 0);

		/* Cleaning */
	cairo_pattern_destroy(pat);
	cairo_destroy(cr);

	if(icn)
		cairo_surface_destroy(icn);
}

void AltitudeGfx::generateOneGfx(const char *fulltarget, char *filename, int index, GPMFdata &current){

		/*
		 * Initialise Cairo
		 */
	cairo_status_t err;

	cairo_surface_t *srf = cairo_image_surface_create(CAIRO_FORMAT_ARGB32, this->SX, this->SY);
	if(cairo_surface_status(srf) != CAIRO_STATUS_SUCCESS){
		puts("*F* Can't create Cairo's surface");
		exit(EXIT_FAILURE);
	}

	cairo_t *cr = cairo_create(srf);

	cairo_set_source_surface(cr, this->background, 0, 0);
	cairo_rectangle(cr, 0,0, this->SX, this->SY);
	cairo_fill(cr);
	cairo_stroke(cr);

		/* Draw Altitude curve */
	if(!this->forcegpx)
		this->drawGPMF(cr, 0, index);

		/* Display the label */
	char t[8];
	sprintf(t, "%5d m", (int)current.getAltitude());
	cairo_select_font_face(cr, "sans", CAIRO_FONT_SLANT_NORMAL, CAIRO_FONT_WEIGHT_BOLD);
	cairo_set_font_size(cr, 35);

	cairo_set_source_rgba(cr, 0,0,0, 0.55);
	cairo_move_to(cr, this->posLabel+2, this->offy+2);
	cairo_show_text(cr, t);
	cairo_stroke(cr);

	cairo_set_source_rgb(cr, 1,1,1);	/* Set white color */
	cairo_move_to(cr, this->posLabel, this->offy);
	cairo_show_text(cr, t);
	cairo_stroke(cr);

		/* Display the spot */
	cairo_set_line_width(cr, 5);
	cairo_arc(cr,
		(this->soffx ? this->soffx : this->offx) + index*(this->soffx ? this->sscale_w : this->scale_w),
		this->SY - (current.getAltitude() - this->min_h)*this->scale_h,
	8, 0, 2 * M_PI);
	cairo_stroke_preserve(cr);
	cairo_set_source_rgb(cr, 0.8, 0.2, 0.2);
	cairo_fill(cr);

		/* Writing the image */
	sprintf(filename, "alt%07d.png", index);
	if(verbose)
		printf("*D* Writing '%s'\r", fulltarget);

	if((err = cairo_surface_write_to_png(srf, fulltarget)) != CAIRO_STATUS_SUCCESS){
		printf("*F* Writing surface : %s / %s\n", cairo_status_to_string(err), strerror(errno));
		exit(EXIT_FAILURE);
	}

		/* Cleaning */
	cairo_destroy(cr);
	cairo_surface_destroy(srf);
}

void AltitudeGfx::GenerateAllGfx( const char *fulltarget, char *filename ){
	Gfx::GenerateAllGfx( fulltarget, filename );

		/* Generate video */
	if(genvideo)
		generateVideo(fulltarget, filename, "alt", "altitude");
}
